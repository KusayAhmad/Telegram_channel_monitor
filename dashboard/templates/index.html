{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<h2 class="page-title"><i class="bi bi-speedometer2"></i> Dashboard</h2>

<!-- Stats Cards -->
<div class="row">
    <div class="col-md-3">
        <div class="card stat-card">
            <i class="bi bi-chat-dots text-primary"></i>
            <div class="stat-number">{{ stats.total_messages }}</div>
            <div class="stat-label">Total Messages</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <i class="bi bi-calendar-day text-success"></i>
            <div class="stat-number">{{ stats.today_messages }}</div>
            <div class="stat-label">Today's Messages</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <i class="bi bi-broadcast text-info"></i>
            <div class="stat-number">{{ channels|length }}</div>
            <div class="stat-label">Monitored Channels</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <i class="bi bi-key text-warning"></i>
            <div class="stat-number">{{ keywords|length }}</div>
            <div class="stat-label">Keywords</div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Recent Messages -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Recent Detected Messages
            </div>
            <div class="card-body">
                {% if recent %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Channel</th>
                                <th>Keyword</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in recent %}
                            <tr>
                                <td>@{{ msg.channel_username }}</td>
                                <td><code>{{ msg.keyword_matched }}</code></td>
                                <td>{{ msg.detected_at }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No messages yet</p>
                {% endif %}
                <a href="{{ url_for('messages') }}" class="btn btn-outline-primary btn-sm">
                    View All <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Top Keywords -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-trophy"></i> Top Matching Keywords
            </div>
            <div class="card-body">
                {% if stats.top_keywords %}
                <ul class="list-group list-group-flush" style="background: transparent;">
                    {% for kw in stats.top_keywords[:5] %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" 
                        style="background: transparent; color: var(--text-color); border-color: rgba(255,255,255,0.1);">
                        {{ kw.keyword_matched }}
                        <span class="badge bg-primary rounded-pill">{{ kw.count }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center">No data available</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-lightning"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('channels') }}" class="btn btn-outline-info">
                        <i class="bi bi-plus-circle"></i> Add Channel
                    </a>
                    <a href="{{ url_for('keywords') }}" class="btn btn-outline-warning">
                        <i class="bi bi-plus-circle"></i> Add Keyword
                    </a>
                    <a href="/api/export/csv" class="btn btn-outline-success">
                        <i class="bi bi-download"></i> Export CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Detected Messages (Last 7 Days)
            </div>
            <div class="card-body">
                <canvas id="messagesChart" class="chart-container"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const dailyCounts = {{ stats.daily_counts | tojson }};
    
    const labels = dailyCounts.map(d => d.date).reverse();
    const data = dailyCounts.map(d => d.count).reverse();
    
    new Chart(document.getElementById('messagesChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Detected Messages',
                data: data,
                borderColor: '#0088cc',
                backgroundColor: 'rgba(0, 136, 204, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#eee' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#aaa' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                y: {
                    ticks: { color: '#aaa' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    });
</script>
{% endblock %}
